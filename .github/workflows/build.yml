name: Build SurfOS Minimal ISO

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Installer værktøjer
        run: |
          sudo apt update
          sudo apt install -y debootstrap xorriso syslinux-utils isolinux mtools genisoimage squashfs-tools grub-efi-amd64 grub-efi-amd64-signed shim-signed

      - name: Lav minimal Debian chroot
        run: |
          sudo mkdir -p chroot
          sudo debootstrap --arch=amd64 bookworm chroot http://deb.debian.org/debian
          sudo chroot chroot apt update
          sudo chroot chroot apt install -y --no-install-recommends $(cat config/package-lists/surfos.list.chroot)

      - name: Opsæt dansk tastatur, locale og autostart
        run: |
          echo "da_DK.UTF-8 UTF-8" | sudo tee -a chroot/etc/locale.gen
          sudo chroot chroot locale-gen
          echo "LANG=da_DK.UTF-8" | sudo tee chroot/etc/default/locale
          sudo chroot chroot dpkg-reconfigure -f noninteractive keyboard-configuration

          sudo chroot chroot useradd -m -s /bin/bash surfos
          sudo cp config/includes.chroot/home/surfos/.xinitrc chroot/home/surfos/.xinitrc
          sudo chmod +x chroot/home/surfos/.xinitrc

          sudo chroot chroot update-initramfs -u -k all

      - name: Lav squashfs og hybrid ISO
        run: |
          sudo mkdir -p live iso/live iso/boot iso/isolinux iso/boot/grub

          sudo mksquashfs chroot live/filesystem.squashfs -comp xz -e chroot/boot

          sudo cp live/filesystem.squashfs iso/live/

          sudo cp /usr/lib/ISOLINUX/isolinux.bin iso/isolinux/
          sudo cp /usr/lib/syslinux/modules/bios/ldlinux.c32 iso/isolinux/

          sudo cp /usr/lib/grub/x86_64-efi-signed/grubx64.efi.signed iso/boot/grub/grubx64.efi

          sudo cp -r chroot/boot/* iso/boot/ || true

          sudo xorriso -as mkisofs -o surfos.iso \
            -b isolinux/isolinux.bin \
            -c isolinux/boot.cat \
            -no-emul-boot -boot-load-size 4 -boot-info-table \
            -eltorito-alt-boot -e boot/grub/grubx64.efi -no-emul-boot \
            iso

          sudo isohybrid surfos.iso

      - name: Vis filer
        run: ls -la *.iso || echo "Ingen ISO fundet"

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: surfos-iso
          path: surfos.iso
          if-no-files-found: warn
